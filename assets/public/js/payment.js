/*! For license information please see payment.js.LICENSE.txt */
(()=>{function e(){var n,r,o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",i=o.toStringTag||"@@toStringTag";function c(e,o,a,i){var c=o&&o.prototype instanceof l?o:l,u=Object.create(c.prototype);return t(u,"_invoke",function(e,t,o){var a,i,c,l=0,u=o||[],d=!1,h={p:0,n:0,v:n,a:m,f:m.bind(n,4),d:function(e,t){return a=e,i=0,c=n,h.n=t,s}};function m(e,t){for(i=e,c=t,r=0;!d&&l&&!o&&r<u.length;r++){var o,a=u[r],m=h.p,p=a[2];e>3?(o=p===t)&&(c=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=n):a[0]<=m&&((o=e<2&&m<a[1])?(i=0,h.v=t,h.n=a[1]):m<p&&(o=e<3||a[0]>t||t>p)&&(a[4]=e,a[5]=t,h.n=p,i=0))}if(o||e>1)return s;throw d=!0,t}return function(o,u,p){if(l>1)throw TypeError("Generator is already running");for(d&&1===u&&m(u,p),i=u,c=p;(r=i<2?n:c)||!d;){a||(i?i<3?(i>1&&(h.n=-1),m(i,c)):h.n=c:h.v=c);try{if(l=2,a){if(i||(o="next"),r=a[o]){if(!(r=r.call(a,c)))throw TypeError("iterator result is not an object");if(!r.done)return r;c=r.value,i<2&&(i=0)}else 1===i&&(r=a.return)&&r.call(a),i<2&&(c=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=n}else if((r=(d=h.n<0)?c:e.call(t,h))!==s)break}catch(e){a=n,i=1,c=e}finally{l=1}}return{value:r,done:d}}}(e,a,i),!0),u}var s={};function l(){}function u(){}function d(){}r=Object.getPrototypeOf;var h=[][a]?r(r([][a]())):(t(r={},a,(function(){return this})),r),m=d.prototype=l.prototype=Object.create(h);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,t(e,i,"GeneratorFunction")),e.prototype=Object.create(m),e}return u.prototype=d,t(m,"constructor",d),t(d,"constructor",u),u.displayName="GeneratorFunction",t(d,i,"GeneratorFunction"),t(m),t(m,i,"Generator"),t(m,a,(function(){return this})),t(m,"toString",(function(){return"[object Generator]"})),(e=function(){return{w:c,m:p}})()}function t(e,n,r,o){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}t=function(e,n,r,o){if(n)a?a(e,n,{value:r,enumerable:!o,configurable:!o,writable:!o}):e[n]=r;else{function i(n,r){t(e,n,(function(e){return this._invoke(n,r,e)}))}i("next",0),i("throw",1),i("return",2)}},t(e,n,r,o)}function n(e,t,n,r,o,a,i){try{var c=e[a](i),s=c.value}catch(e){return void n(e)}c.done?t(s):Promise.resolve(s).then(r,o)}function r(e){return function(){var t=this,r=arguments;return new Promise((function(o,a){var i=e.apply(t,r);function c(e){n(i,o,a,c,s,"next",e)}function s(e){n(i,o,a,c,s,"throw",e)}c(void 0)}))}}var o=wp.i18n.__;jQuery((function(t){"use strict";if(window.wc_checkout_params&&window.lemonway_payment&&(lemonway_payment.is_checkout_pay_page||lemonway_payment.is_checkout_page)){var n={checkoutForm:"form.checkout, form#order_review",checkoutFormButton:"#place_order",loading:"form.checkout, form#order_review",paypalContainerSelector:"#lemonway-paypal-button-container",cardContainerSelector:"#lemonway-payment-method-card-fields",paymentType:"card",paymentMethod:"",orderSuccessRedirectUrl:"",orderCancelRedirectUrl:"",hostedFields:null,isPaypalInitialized:!1,isCardInitialized:!1,currentOrderId:"",isProcessing:!1,initialize:function(){var t=this;return r(e().m((function n(){var r;return e().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,t.clear(),t.showLoadingState(),e.n=1,Promise.allSettled([t.initializePaypalButton(),t.initializeCardFields()]);case 1:e.v.forEach((function(e,t){var n=0===t?"initializePaypalButton":"initializeCardFields";"fulfilled"!==e.status&&console.info("❌ ".concat(n," failed:"),e.reason)})),t.updatePaymentUI(),t.setupPaymentMethodListeners(),e.n=3;break;case 2:e.p=2,r=e.v,t.handleError("".concat(wc_checkout_params.i18n_checkout_error)),console.error("Payment initialization failed:",r);case 3:return e.a(2)}}),n,null,[[0,2]])})))()},init:function(){var n=this;t((function(){n.showLoadingState(),n.selectPaymentMethod();var o=function(){var t=r(e().m((function t(){return e().w((function(e){for(;;)switch(e.n){case 0:return e.n=1,n.initialize();case 1:setTimeout((function(){n.hideLoadingState()}),1e3);case 2:return e.a(2)}}),t)})));return function(){return t.apply(this,arguments)}}();t(document.body).on("updated_checkout",o),o()}))},clear:function(){this.isCardInitialized&&(t("#lemonway-card-holder-name").empty(),t("#lemonway-card-number").empty(),t("#lemonway-card-expiration-date").empty(),t("#lemonway-card-cvv").empty(),this.hostedFields=null,this.isCardInitialized=null),this.isPaypalInitialized&&(t(this.paypalContainerSelector).empty(),this.isPaypalInitialized=!1)},showLoadingState:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];t(this.loading).addClass("processing").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),e&&t(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message, .is-error, .is-success").remove()},hideLoadingState:function(){t(this.loading).removeClass("processing").unblock()},resetOrderData:function(){this.orderSuccessRedirectUrl="",this.orderCancelRedirectUrl="",this.currentOrderId="",this.isProcessing=!1},handleError:function(e){if(this.isProcessing&&(this.hideLoadingState(),this.resetOrderData()),t(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message, .is-error, .is-success").remove(),t(this.checkoutForm).length){var n=e,r=t("<div>").html(e);0!==r.find(".woocommerce-error").length||r.is(".woocommerce-error")||(n='<div class="woocommerce-error">'.concat(e,"</div>")),t(this.checkoutForm).prepend('\n\t\t\t\t\t<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-checkout">\n\t\t\t\t\t\t'.concat(n,"\n\t\t\t\t\t</div>\n\t\t\t\t")),t(this.checkoutForm).find(".input-text, select, input:checkbox").trigger("validate").trigger("blur"),this.scrollToError()}t(document.body).trigger("checkout_error",[e])},scrollToError:function(){var e=t(this.checkoutForm),n=100,r=t("#site-header");r.length&&(n=r.outerHeight()+15),e.length&&t("html, body").animate({scrollTop:e.offset().top-n},1e3)},updatePaymentUI:function(){if(t(this.paypalContainerSelector).hide(),t(this.cardContainerSelector).hide(),this.isLemonwaySelected())switch(this.paymentType){case"card":t(this.checkoutFormButton).show(),t(this.cardContainerSelector).show();break;case"paypal":t(this.checkoutFormButton).hide(),t(this.paypalContainerSelector).show()}else t(this.checkoutFormButton).show()},isLemonwaySelected:function(){return"lemonway-gateway"===this.paymentMethod},selectPaymentMethod:function(){this.paymentType=t(this.checkoutForm).find('input[name="lemonway_payment_type"]:checked').val()||"",this.paymentMethod=t(this.checkoutForm).find('input[name="payment_method"]:checked').val(),this.updatePaymentUI()},setupPaymentMethodListeners:function(){var e=this;t(this.checkoutForm).on("change",'input[name="payment_method"], input[name="lemonway_payment_type"]',(function(){e.selectPaymentMethod()})),t(this.checkoutForm).on("change","select#billing_country",(function(){}))},handleCountryChange:function(){var t=this;return r(e().m((function n(){return e().w((function(e){for(;;)switch(e.n){case 0:return t.showLoadingState(),e.n=1,t.initialize();case 1:t.hideLoadingState();case 2:return e.a(2)}}),n)})))()},initializeCardFields:function(){var e=this;return new Promise((function(n,r){var o=0,a=function(){if(window.LwHostedFields&&"function"==typeof window.LwHostedFields.findLabelFor){e.isCardInitialized=!0;var i="\n                            #text { color: black; }\n                            #text.invalid { color: red; }\n                            #text.valid { font-weight: bolder; }\n                        ",c={server:{webkitToken:"Initialize via MoneyInWebInit API"},client:{holderName:{containerId:"lemonway-card-holder-name",placeHolder:"Hans Müller",style:i},cardNumber:{containerId:"lemonway-card-number",placeHolder:"4111 1111 1111 1111",style:i},expirationDate:{containerId:"lemonway-card-expiration-date",placeHolder:"MM/YY",style:i},cvv:{containerId:"lemonway-card-cvv",placeHolder:"123",style:i}}};e.hostedFields=new LwHostedFields(c),e.hostedFields.mount(),t(document).on("click",e.checkoutFormButton,(function(t){e.selectPaymentMethod(),"card"===e.paymentType&&e.isLemonwaySelected()&&(t.preventDefault(),e.processCardPayment())})),n()}else++o>=10?(t(".lemonway-payment-method-card").hide(),t("#lemonway-payment-type-paypal").trigger("click"),r(new Error("LwHostedFields not available."))):setTimeout(a,500)};a()}))},processCardPayment:function(){var t=this;return r(e().m((function n(){var r,o,a;return e().w((function(e){for(;;)switch(e.n){case 0:if(!t.isProcessing){e.n=1;break}return e.a(2);case 1:return t.isProcessing=!0,t.showLoadingState(!0),e.p=2,e.n=3,t.submitOrderRequest();case 3:if(r=e.v,!(o=t.processPaymentResponse(r))||!o.token){e.n=4;break}return e.n=4,t.submitCardPayment(o.token);case 4:e.n=6;break;case 5:e.p=5,a=e.v,t.handleError("".concat(a.message||wc_checkout_params.i18n_checkout_error));case 6:return e.a(2)}}),n,null,[[2,5]])})))()},submitCardPayment:function(t){var n=this;return r(e().m((function r(){var o;return e().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,n.hostedFields){e.n=1;break}throw new Error("Hosted fields not initialized");case 1:return n.hostedFields.config.webkitToken=t,e.n=2,n.hostedFields.submit();case 2:n.orderSuccessRedirectUrl&&(window.location.href=n.orderSuccessRedirectUrl),e.n=4;break;case 3:throw e.p=3,o=e.v,new Error("Card payment failed: ".concat(o.message));case 4:return e.a(2)}}),r,null,[[0,3]])})))()},initializePaypalButton:function(){var e=this;return new Promise((function(n,r){var o=0,a=function(){window.paypal&&window.paypal.Buttons?(e.isPaypalInitialized=!0,window.paypal.Buttons({createOrder:function(){return e.createPaypalOrder()},onApprove:function(t,n){return e.approvePaypalPayment(n)},onCancel:function(){return e.cancelPaypalPayment()},onError:function(t){return e.handlePaypalError(t)},fundingSource:window.paypal.FUNDING.PAYPAL}).render(e.paypalContainerSelector).catch((function(e){console.error("PayPal button render failed:",e)})),n()):++o>=10?(t(e.paypalContainerSelector).hide(),r(new Error("PayPal SDK not available."))):setTimeout(a,500)};a()}))},createPaypalOrder:function(){var t=this;return r(e().m((function n(){var r,o;return e().w((function(e){for(;;)switch(e.n){case 0:if(t.isLemonwaySelected()){e.n=1;break}throw new Error("Lemonway payment method not selected");case 1:return t.showLoadingState(!0),e.p=2,e.n=3,t.submitOrderRequest();case 3:return r=e.v,e.a(2,t.processPaymentResponse(r));case 4:throw e.p=4,o=e.v,t.handleError("".concat(o.message)),o;case 5:return e.a(2)}}),n,null,[[2,4]])})))()},approvePaypalPayment:function(e){var t=this;return new Promise((function(n){t.capturePayment(t.currentOrderId,t.orderSuccessRedirectUrl,e).then(n).catch((function(e){t.handleError("".concat(e.message)),n()}))}))},cancelPaypalPayment:function(){this.handleError(" ".concat(o("Your payment has been cancelled. Please try again or contact support if the issue persists.","lemonway"))),this.hideLoadingState(),this.resetOrderData()},handlePaypalError:function(e){t(".woocommerce-error").length||this.handleError("".concat(e.toString())),this.hideLoadingState(),this.resetOrderData()},submitOrderRequest:function(){var e=this,n=lemonway_payment.is_checkout_pay_page,r=n?{order_id:lemonway_payment.order_id,action:"lemonway_create_order",nonce:lemonway_payment.nonce,lemonway_payment_type:this.paymentType}:t(this.checkoutForm).serialize();return t.ajax({type:"POST",url:n?lemonway_payment.ajaxurl:wc_checkout_params.checkout_url,data:r,dataType:"json"}).fail((function(t,n,r){e.hideLoadingState(),e.handleError("".concat(r))}))},processPaymentResponse:function(e){var n,r;if(lemonway_payment.is_checkout_pay_page&&(e=(null===(r=e.data)||void 0===r?void 0:r.data)||e),!e)throw new Error("Empty server response");if("success"===e.result)switch(this.orderSuccessRedirectUrl=e.success_redirect,this.orderCancelRedirectUrl=e.cancel_redirect,this.currentOrderId=e.order_id,e.payment_type){case"card":return{token:e.token,lemonway_transaction_id:e.lemonway_transaction_id};case"paypal":return e.paypal_order_id;default:return console.warn("Unknown payment type:",e),this.handleError("".concat(o("Unknown payment type. Please try again or contact support if the issue persists.","lemonway"))),null}throw e.reload&&window.location.reload(),e.refresh&&t(document.body).trigger("update_checkout"),new Error(e.messages||(null===(n=e.data)||void 0===n?void 0:n.message)||wc_checkout_params.i18n_checkout_error)},capturePayment:function(e,n,r){return this.showLoadingState(),t.ajax({type:"POST",url:lemonway_payment.ajaxurl,data:{order_id:e,action:"lemonway_capture_payment",nonce:lemonway_payment.nonce},dataType:"json"}).then((function(e){if(!e.success){var t,o,a,i=null===(t=e.data)||void 0===t||null===(t=t.message)||void 0===t||null===(t=t.details)||void 0===t?void 0:t[0];if("INSTRUMENT_DECLINED"===(null==i?void 0:i.issue)&&null!=r&&r.restart)return r.restart();var c=(null==i?void 0:i.description)||(null===(o=e.data)||void 0===o||null===(o=o.message)||void 0===o?void 0:o.message)||(null===(a=e.data)||void 0===a?void 0:a.message);throw new Error(c)}window.location.href=n})).catch((function(e){var t;if(null===(t=e.responseJSON)||void 0===t||!t.reload)throw e;window.location.reload()}))}};n.init()}}))})();